<?xml version='1.0' encoding='ISO-8859-1'?>
<!--
# Copyright (c) 1986-2016 Pixar. All rights reserved.
#
# The information in this file (the "Software") is provided for the exclusive
# use of the software licensees of Pixar ("Licensees").  Licensees have the
# right to incorporate the Software into other products for use by other
# authorized software licensees of Pixar, without fee. Except as expressly
# permitted herein, the Software may not be disclosed to third parties, copied
# or duplicated in any form, in whole or in part, without the prior written
# permission of Pixar.
#
# The copyright notices in the Software and this entire statement, including the
# above license grant, this restriction and the following disclaimer, must be
# included in all copies of the Software, in whole or in part, and all permitted
# derivative works of the Software, unless such copies or derivative works are
# solely in the form of machine-executable object code generated by a source
# language processor.
#
# PIXAR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL PIXAR BE
# LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
# OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
# CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  IN NO CASE WILL
# PIXAR'S TOTAL LIABILITY FOR ALL DAMAGES ARISING OUT OF OR IN CONNECTION WITH
# THE USE OR PERFORMANCE OF THIS SOFTWARE EXCEED $50.
#
# Pixar
# 1200 Park Ave
# Emeryville CA 94608

$ Revision: $
-->

<?xml-stylesheet type="text/xsl" href="#stylesheet"?>
<!DOCTYPE doc [ 
<!ATTLIST xsl:stylesheet
  id    ID    #REQUIRED> 
]>
<doc>
<xsl:stylesheet version="1.0"
                id="stylesheet"
                xmlns:rm="http://renderman.pixar.com"
                xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:output method="html" media-type="text/html" 
            version="4.0" encoding="iso-8859-1" indent="yes"/>
<xsl:template match="xsl:stylesheet" />

<!-- The root of the XML tree is a statsDoc.  Just output some base html -->
<xsl:template match="rm:statsDoc">
<html style="height: 100%; width: 100%;">
  <head>
    <title>Rendering stats</title>
    <!-- Copy xml into the DOM.-->
    <xsl:copy>
        <xsl:attribute name="hidden"/>
        <xsl:attribute name="id">xml_data</xsl:attribute>
        <xsl:apply-templates select="@*|node()"/>
    </xsl:copy>
    <!-- Include inline style sheet.-->
    <xsl:call-template name="InlineScript"/>
  </head>
  <body>
      <div id="main"> 
      </div>
  </body>
</html>
</xsl:template>

<xsl:template match="@*|node()">
  <xsl:copy>
    <xsl:apply-templates select="@*|node()"/>
  </xsl:copy>
</xsl:template>


<xsl:template name="InlineScript">
  <!-- Script to load the rmanStats.js file which does the actual work -->
  <script> 
    /** load a javascript from a url */
    function loadScript(url, onLoad, onError)
    {
        var head = document.getElementsByTagName('head')[0];
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = url;

        // Then bind the event to the callback function.
        // There are several events for cross browser compatibility.
        script.onreadystatechange = onLoad;
        script.onload = onLoad;
        script.onerror = onError;

        //Fire the loading
        head.appendChild(script);
    }
    
    var onLoadBootStrap = function(jsLoaded) {
      console.log("rmanStats_2.0.js loaded from " + jsLoaded.name + ": " 
                  + jsLoaded.url);
    };
    
    /* For the case that the script isn't loaded from a url,
      go to the next in line.
    */
    var onError = function(jsLocations) {
      console.log("rmanStats_2.0.js specified in " + jsLocations[0].name + 
                  " , " + jsLocations[0].url + " not found.");

      if(jsLocations.length > 1) {
        var newLocations = jsLocations.slice(1, jsLocations.length);
        loadScript(newLocations[0].url, 
                  function() { onLoadBootStrap(newLocations[0]);}, 
                  function() { onError(newLocations[0]);});
      }
      else {
        alert("No javascript found for rendering stats page!");
      }
    };
    
    //a list of locations where we can find the js for rendering xml
    jsLocations = [];

    //stats compatability version
    statsVersion =<xsl:value-of select='statsview/version'></xsl:value-of>;
    
    //check if browser has localstorage and check for user setting
    if(typeof window.localStorage != 'undefined') {
      if (localStorage.rmanStatsScript) {
        jsLocations.push({name: 'user setting', 
                          url: localStorage.rmanStatsScript});
      }
    }

    //first check in the xml rmantree setting
    jsFile = "js/rmanStats_2.0.js";
    rmantreeHtml = "<xsl:value-of select='statsview/rmanHtmlDir'>
                    </xsl:value-of>";
    jsLocations.push({name: 'rmantree in xml', url:rmantreeHtml + jsFile});

    //check if networkHtml setting is set
    networkHtml = "<xsl:value-of select='statsview/networkHtmlDir'>
                  </xsl:value-of>";
    if(networkHtml != '') {
      jsLocations.push({name: 'network setting', url: networkHtml + '/' 
                        + statsVersion + '/' + jsFile});
    }
    
    //finally use the one found on renderman.pixar.com
    rmanURL = "https://renderman.pixar.com/statsview/";
    jsLocations.push({name: 'www', url: rmanURL + statsVersion + "/" + jsFile});

    //try to load the first js file specified, will chain to next if error
    loadScript(jsLocations[0].url, 
                function() { onLoadBootStrap(jsLocations[0]);}, 
                function() { onError(jsLocations) });
  </script>
</xsl:template>

</xsl:stylesheet>


<rm:statsDoc xmlns:rm="http://renderman.pixar.com" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://renderman.pixar.com http://renderman.pixar.com/schema/rmStats_1.1.xsd" rmanHtmlDir="/Applications/Pixar/RenderManProServer-21.3/etc/statsview/">
    <statsview>
	<version>2</version>
	<rmanHtmlDir>/Applications/Pixar/RenderManProServer-21.3/etc/statsview/</rmanHtmlDir>
    </statsview>